# 故障排查指南

## 问题：找不到输入框（Timeout Error）

这是最常见的问题。可能的原因和解决方案：

### 解决方案 1：检查截图

脚本现在会自动保存3张截图：
- `page_loaded.png` - 页面加载后的状态
- `after_fill.png` - 填写域名后的状态
- `final_result.png` - 最终结果

**如何查看截图：**
1. 进入 GitHub Actions 执行记录
2. 向下滚动到 "Artifacts" 部分
3. 下载 `screenshots-xxx` 文件
4. 查看截图，确认页面是否正常加载

### 解决方案 2：查看调试日志

如果找不到输入框，脚本会保存 `page_debug.html` 文件：

1. 在 Actions artifacts 中下载 `renewal-logs-xxx`
2. 打开 `page_debug.html` 文件
3. 查找输入框的实际 HTML 结构
4. 根据实际结构修改脚本

### 解决方案 3：网站可能需要登录

如果网站改变了访问策略，可能需要：

1. **检查网站是否可以直接访问**
   - 在浏览器中打开 https://freexcraft.com/external-renew
   - 确认是否需要登录

2. **如果需要登录**，需要修改脚本添加登录功能

### 解决方案 4：增加等待时间

有时页面加载较慢，可以增加等待时间：

编辑 `renew.py`，找到这一行：
```python
await page.wait_for_timeout(3000)
```

改成：
```python
await page.wait_for_timeout(5000)  # 等待5秒
```

### 解决方案 5：检查网络问题

GitHub Actions 的服务器可能无法访问某些网站：

1. 查看日志中的 "正在访问" 部分
2. 确认是否能成功访问网站
3. 如果无法访问，可能是网站封禁了 GitHub 的 IP

## 常见错误信息

### "Timeout 30000ms exceeded"

**原因：** 30秒内找不到指定元素

**解决：**
1. 检查截图，确认页面内容
2. 查看 page_debug.html，确认元素是否存在
3. 可能需要修改选择器

### "Page.goto: net::ERR_NAME_NOT_RESOLVED"

**原因：** 无法解析域名

**解决：**
1. 检查网站是否在线
2. 可能是临时网络问题，等待下次自动执行

### "Page.goto: net::ERR_CONNECTION_REFUSED"

**原因：** 服务器拒绝连接

**解决：**
1. 网站可能暂时下线
2. 可能被 GitHub 的 IP 段封禁

## 调试技巧

### 本地测试

在本地运行脚本更容易调试：

```bash
# 安装依赖
pip install playwright
playwright install chromium

# 运行脚本
python renew.py
```

本地运行会在当前目录生成截图和日志文件。

### 启用详细日志

编辑 `renew.py`，将日志级别改为 DEBUG：

```python
logging.basicConfig(
    level=logging.DEBUG,  # 改为 DEBUG
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('renewal.log'),
        logging.StreamHandler()
    ]
)
```

### 无头模式关闭（仅本地）

本地测试时，可以看到浏览器操作：

```python
browser = await p.chromium.launch(
    headless=False,  # 改为 False，会显示浏览器窗口
    args=['--no-sandbox', '--disable-setuid-sandbox']
)
```

## 手动修复选择器

如果你查看了 HTML 结构，发现输入框的实际选择器不同：

### 1. 找到输入框的正确选择器

在 `page_debug.html` 中搜索 "input"，找到类似这样的代码：
```html
<input class="my-custom-class" id="server-name" type="text">
```

### 2. 修改脚本

编辑 `renew.py`，找到 `input_selectors` 列表，添加你发现的选择器：

```python
input_selectors = [
    '#server-name',           # 使用 ID
    '.my-custom-class',       # 使用 class
    'input[type="text"]',     # 原有的选择器
    # ... 其他选择器
]
```

### 3. 同样处理按钮

如果按钮也找不到，修改 `button_selectors`：

```python
button_selectors = [
    '#renew-button',          # 添加你找到的选择器
    'button:has-text("Renew & Start")',
    # ... 其他选择器
]
```

## 获取帮助

如果以上方法都无法解决问题：

1. **下载所有 artifacts**（截图和日志）
2. **创建 GitHub Issue** 包含：
   - 错误信息
   - 截图
   - page_debug.html 的关键部分
3. **检查网站是否更新** - 网站结构可能改变

## 预防措施

### 定期检查

建议每周检查一次：
1. 进入 Actions 页面
2. 查看最近的执行记录
3. 确认都是绿色（成功）

### 设置通知

GitHub 可以在 Action 失败时发邮件：
1. 进入仓库 Settings
2. 找到 Notifications
3. 启用 "Email notifications for failed workflows"

### 备用方案

如果自动化失败，可以手动续期：
1. 访问 https://freexcraft.com/external-renew
2. 输入 `laohu.xmania.me`
3. 点击 Renew & Start

## 成功的标志

脚本成功运行时，日志应该包含：

```
✓ 续期成功！服务器已续期并启动
```

或者页面文本中包含：
- "Server renewed"
- "already running"
- "extended"
- "started"
